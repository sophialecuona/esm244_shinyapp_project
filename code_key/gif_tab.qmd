---
title: "Gif Tab"
format: html
editor: visual
---

Flanders Marine Institute (2023). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 12. Available online at https://www.marineregions.org/. https://doi.org/10.14284/632

# Read in EEZ

```{r}
library(tidyverse)
library(here)
library(broom)
library(janitor)
library(ggplot2)

# Spatial data packages
library(sf)
library(tmap)
library(spatstat)
library(terra) 
```

```{r}
ca_counties_raw_sf <- read_sf(here("data", "ca_counties2", "CA_Counties_TIGER2016.shp"))
```

```{r}
# eez_raw_sf <- read_sf(here("data", "World_EEZ_v12_20231025", "eez_boundaries_v12.shp"))
# 
# eez2_raw_sf <- read_sf(here("data", "World_EEZ_v12_20231025", "eez_v12.shp"))
```

```{r}
# eez_raw_sf %>% st_crs()
# eez_raw_sf %>% terra::crs() #WGS84
# 
# eez2_raw_sf %>% st_crs()
# eez2_raw_sf %>% terra::crs()#WGS84

ca_counties_raw_sf %>% st_crs()
ca_counties_raw_sf %>% terra::crs()
# 
# eez2_proj_sf <- st_transform(eez2_raw_sf, st_crs(ca_counties_raw_sf))
```

```{r}
# plot(eez_raw_sf)
# plot(eez2_raw_sf)
```

# Clipping to CA Counties

```{r}
# output = st_intersection(eez2_proj_sf, ca_counties_raw_sf)
# plot(output)
```

```{r}
# # Set http.postBuffer size to 524288000 bytes (500MB)
# buffer_size_bytes <- 524288000
# 
# # Execute git config command from R
# command <- paste("git config http.postBuffer", buffer_size_bytes)
# system(command)
```

```{r}
ca_counties_sf <- ca_counties_raw_sf %>% 
  janitor::clean_names() %>%
  mutate(land_km2 = aland / 1e6) %>%
  select(county = name, land_km2)
```

```{r}
dung_survey <- read_csv(here("data/dungeness_survey_data.csv")) 

dung_clean <- dung_survey %>%
  clean_names() %>%
  mutate(haul_id = dataset_west_coast_annual,
         stratum = x2,
         lat = x3,
         long = x4,
         depth = x5,
         year = x6,
         wtcpue = x7) %>%
  mutate(species = "dungeness") %>%
  select(species, haul_id, stratum, lat, long, depth, year, wtcpue) %>%
  drop_na()

squid_survey <- read_csv(here("data/squid_survey_data.csv")) 

squid_clean <- squid_survey %>%
  clean_names() %>%
  mutate(haul_id = dataset_west_coast_annual,
         stratum = x2,
         lat = x3,
         long = x4,
         depth = x5,
         year = x6,
         wtcpue = x7) %>%
  mutate(species = "squid") %>%
  select(species, haul_id, stratum, lat, long, depth, year, wtcpue) %>%
  drop_na()

full_dung_squid <- full_join(
  dung_clean,
  squid_clean,
  by = NULL,
  suffix = c(".x", ".y"),
  keep = FALSE
)

chinook_survey <- read_csv(here("data/chinook_salmon_survey.csv")) 

chinook_clean <- chinook_survey %>%
  clean_names() %>%
  mutate(haul_id = dataset_west_coast_triennial,
         stratum = x2,
         lat = x3,
         long = x4,
         depth = x5,
         year = x6,
         wtcpue = x7) %>%
  mutate(species = "chinook") %>%
  select(species, haul_id, stratum, lat, long, depth, year, wtcpue) %>%
  drop_na()

full_dung_squid_chin <- full_join(
  full_dung_squid,
  chinook_clean,
  by = NULL,
  suffix = c(".x", ".y"),
  keep = FALSE
) %>%
  filter(!wtcpue == 0)
```

# Wrangling survey and ca shapefile

```{r}
sf_dsc <- st_as_sf(full_dung_squid_chin, coords = c("long", "lat"), crs = 4326)

dsc <- st_transform(sf_dsc, st_crs(ca_counties_raw_sf))

plot(dsc)

output = st_intersection(dsc, ca_counties_sf)
plot(output)

ggplot() +
  geom_sf(data = ca_counties_sf) +
  geom_sf(data = output, size = 1, color = output$species)

map <- ggplot() +
  geom_sf(data = ca_counties_sf, 
          color = "darkorchid", 
          fill = "darkorchid4", 
          size = 1) +
  geom_sf(data = dsc, 
          color = "orange", 
          alpha = 0.7, 
          size = 2) +
  theme_void()
map

#clipping map
map_clip <- map + coord_sf(ylim=c(32, 42))
map_clip #having issues
```

# Cool hotspot map? (DIDNT WORK)

```{r}
#hotspot map

### Convert vole observations to spatial point pattern
dsc_ppp <- as.ppp(dsc) 

# transform the projection to match:

ca_sf <- st_transform(ca_counties_sf, st_crs(dsc))

### Convert county boundary to observation window
ca_win <- as.owin(ca_sf) 

### Combine as a point pattern object (points + window):
dsc_full <- ppp(dsc_ppp$x, dsc_ppp$y, window = ca_win)

plot(dsc_full) 
### Illegal point (outside window) shows up as the plus sign

# DENSITY!
dsc_density <- density(dsc_full, sigma = 5000) ### try different sigmas

plot(dsc_density)
```

### failed way to clip dsc

```{r}
## clipping but leaving ocean

lat_min <- 32  # Minimum latitude
lat_max <- 42  # Maximum latitude

# Create a polygon representing the latitude range
lat_polygon <- st_polygon(list(rbind(c(-180, lat_min), c(-180, lat_max), c(180, lat_max), c(180, lat_min), c(-180, lat_min))))

# Convert the polygon to an sf object with the same CRS as ca_counties_sf
lat_polygon_sf <- st_sf(geometry = st_sfc(lat_polygon), crs = st_crs(ca_counties_sf))

# Clip
clipped_sf <- st_intersection(dsc, lat_polygon_sf)

plot(clipped_sf)

ggplot() +
  geom_sf(data = ca_counties_sf, 
          color = "darkorchid", 
          fill = "darkorchid4", 
          size = 1) +
  geom_sf(data = clipped_sf, 
          color = "orange", 
          alpha = 0.7, 
          size = 2) +
  theme_void()
# not working
```


# Plotting catch data by year for each species

## Dungeness
```{r}

```

## Chinook
```{r}

```


## Squid
```{r}

```

